{
  "data": [
    {
      "id": "6_1694150718.656",
      "type": "feed",
      "offset": 6,
      "verb": "TOPIC_ACKNOWLEDGED_ANSWER",
      "created_time": 1694150718,
      "updated_time": 1694150718,
      "target": {
        "id": 3201442432,
        "type": "answer",
        "url": "https://api.zhihu.com/answers/3201442432",
        "author": {
          "id": "32d3fd8de766dcfae73d01619574e7e8",
          "url": "https://api.zhihu.com/people/32d3fd8de766dcfae73d01619574e7e8",
          "user_type": "people",
          "url_token": "yue-ai-yue-shen-72",
          "name": "躺平的菜狗",
          "headline": "此处还有座，诸位请上座。特邀共阅情感世界。",
          "avatar_url": "https://pica.zhimg.com/50/v2-2560f33bfe62590e54934b778fa71c71_l.jpg?source=b6762063",
          "is_org": false,
          "gender": 1,
          "followers_count": 216,
          "is_following": false,
          "is_followed": false
        },
        "created_time": 1694089397,
        "updated_time": 1694091358,
        "voteup_count": 24,
        "thanks_count": 5,
        "comment_count": 4,
        "is_copyable": true,
        "question": {
          "id": 620647984,
          "type": "question",
          "url": "https://api.zhihu.com/questions/620647984",
          "author": {
            "id": "26d18851ad472aaf33cfacead4edf143",
            "url": "https://api.zhihu.com/people/26d18851ad472aaf33cfacead4edf143",
            "user_type": "people",
            "url_token": "flossie-9",
            "name": "Flossie",
            "headline": "",
            "avatar_url": "https://picx.zhimg.com/50/v2-1a4287a1956e7bcc4ea5901ea1effed8_l.jpg?source=b6762063",
            "is_org": false,
            "gender": -1,
            "followers_count": 1,
            "is_following": false,
            "is_followed": false
          },
          "title": "男朋友嫌我四个伴娘多跟我生气，还要结婚吗?",
          "created": 1693923455,
          "answer_count": 173,
          "follower_count": 173,
          "comment_count": 9,
          "bound_topic_ids": [
            960,
            3510,
            3511,
            9628,
            158885
          ],
          "is_following": false,
          "excerpt": "",
          "relationship": {
            "is_author": false
          },
          "detail": "",
          "question_type": "normal"
        },
        "thumbnail": "https://picx.zhimg.com/50/v2-e722ce5fd60830d185527f8d83422e11_720w.jpg?source=b6762063",
        "excerpt": "给大家提供一下题主和男友其他方面的问题，以供参考。为防止手机看不清，以下为简短总结。 题主和男友在结婚前就因房子问题，见父母问题而上知乎发过。 女生觉得不受对方父母待见，不受公平对待，自己是个没话语权的外人。男方觉得自己没亏欠，做的很好。 无一例外，热度不高，没什么大的矛盾点，可以回答的地方都很少。    你们在一起是图什么呢？我就想问图什么呢？ 曾经我很相信别人说的，喜欢一个人就要喜欢他的全部。后来我才…",
        "excerpt_new": "给大家提供一下题主和男友其他方面的问题，以供参考。为防止手机看不清，以下为简短总结。 题主和男友在结婚前就因房子问题，见父母问题而上知乎发过。 女生觉得不受对方父母待见，不受公平对待，自己是个没话语权的外人。男方觉得自己没亏欠，做的很好。 无一例外，热度不高，没什么大的矛盾点，可以回答的地方都很少。    你们在一起是图什么呢？我就想问图什么呢？ 曾经我很相信别人说的，喜欢一个人就要喜欢他的全部。后来我才…",
        "preview_type": "default",
        "preview_text": "",
        "reshipment_settings": "allowed",
        "content": "\u003cp data-pid=\"_4xWBntX\"\u003e给大家提供一下题主和男友其他方面的问题，以供参考。为防止手机看不清，以下为简短总结。\u003c/p\u003e\u003cblockquote data-pid=\"meRq35Og\"\u003e题主和男友在结婚前就因房子问题，见父母问题而上知乎发过。 女生觉得不受对方父母待见，不受公平对待，自己是个没话语权的外人。男方觉得自己没亏欠，做的很好。 无一例外，热度不高，没什么大的矛盾点，可以回答的地方都很少。\u003c/blockquote\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-fc0fb39686fe67c576f947b09ac08a2e_b.jpg\" data-size=\"normal\" data-rawwidth=\"1038\" data-rawheight=\"807\" data-original-token=\"v2-fc0fb39686fe67c576f947b09ac08a2e\" data-default-watermark-src=\"https://pic3.zhimg.com/v2-96b6e1aa5cc0b164583e9bf26330d8e6_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1038\" data-original=\"https://pica.zhimg.com/v2-fc0fb39686fe67c576f947b09ac08a2e_r.jpg\"/\u003e\u003cfigcaption\u003e婚前已经炸裂\u003c/figcaption\u003e\u003c/figure\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-0ebd8811b9d29061ba63d0e4e7109d82_b.jpg\" data-size=\"normal\" data-rawwidth=\"1052\" data-rawheight=\"684\" data-original-token=\"v2-0ebd8811b9d29061ba63d0e4e7109d82\" data-default-watermark-src=\"https://picx.zhimg.com/v2-0ac38ccb619e648ed37a892c333797d5_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1052\" data-original=\"https://pic3.zhimg.com/v2-0ebd8811b9d29061ba63d0e4e7109d82_r.jpg\"/\u003e\u003cfigcaption\u003e男方也不满\u003c/figcaption\u003e\u003c/figure\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-5eec4a36e36811831e166b82fa6938a8_b.jpg\" data-size=\"normal\" data-rawwidth=\"1008\" data-rawheight=\"659\" data-original-token=\"v2-5eec4a36e36811831e166b82fa6938a8\" data-default-watermark-src=\"https://picx.zhimg.com/v2-e7617548259922131538a9486cf9c671_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1008\" data-original=\"https://pic3.zhimg.com/v2-5eec4a36e36811831e166b82fa6938a8_r.jpg\"/\u003e\u003cfigcaption\u003e女生更是难受不行\u003c/figcaption\u003e\u003c/figure\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-a2c536e30c6bcb2346bf2ff219ffe476_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1074\" data-rawheight=\"753\" data-original-token=\"v2-a2c536e30c6bcb2346bf2ff219ffe476\" data-default-watermark-src=\"https://pic2.zhimg.com/v2-67882d9a0fd38796b0e1fb4916e2c983_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1074\" data-original=\"https://pica.zhimg.com/v2-a2c536e30c6bcb2346bf2ff219ffe476_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"zeDdjndK\"\u003e你们在一起是图什么呢？我就想问图什么呢？\u003c/p\u003e\u003cp data-pid=\"ZN5hvkDq\"\u003e 曾经我很相信别人说的，喜欢一个人就要喜欢他的全部。后来我才发现，\u003cb\u003e因为他全部都让人很喜欢，才喜欢他这个人，更值得普通人去追求。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"WB9ZoW3G\"\u003e前者意味着你要无限包容和磨合，但江山易改本性难移。别说什么爱他就会包容他，爱她就会为她改变。那都是屁话。见过只有几十年因为家庭卫生问题争吵不断的，基本没见过一个两个人彻底变得邋遢或干净洁癖的。\u003c/p\u003e\u003cp data-pid=\"Q5n_mWlD\"\u003e你怎么可能让一个从小认知教育就和你不同的人，去因为和你短暂的相处而变得不一样。更何况人格心理学告诉我们，人格最大的特点之一就是稳定。要是因你而突然变化，你还要思考一下要不要和这个人在一起，因为太容易受人影响。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"CUu5GQAQ\"\u003e婚前就因为各种令人摸不到头脑的事情各执一词，一个觉得对方太作，一个觉得对方不重视自己（经朋友告知）。你们这三观，没看出来有什么相似的地方啊。只能说生活上有些互补，或者说相处时间长了，习惯了对方的存在。\u003c/p\u003e\u003cp data-pid=\"sSoCOKAI\"\u003e可婚姻不是恋爱，不是平时只要吃喝不愁，就可以开开心心的恋爱生活。你们的婚姻更是由于自己的不独立，已经被两方父母给死死控制住。或者说你被其他所有人给死死的控制住。\u003c/p\u003e\u003cp data-pid=\"i0nSrOm5\"\u003e觉得不被尊重需要被人提醒才知道，感觉他家里对你不重视要自己爸妈来说，感觉他生活中让你觉得关系不平等还得来知乎说，现在甚至伴娘多选两个都得让网友评论。\u003c/p\u003e\u003cp data-pid=\"t38N5c_l\"\u003e\u003cb\u003e海燕啊，你可长点心吧！\u003c/b\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"FHTCyDE3\"\u003e你图啥呢？他家是有低保还是怎么着？\u003c/p\u003e\u003cp data-pid=\"ynM1EN7t\"\u003e\u003cb\u003e都已经觉得不平等了，不被尊重了，还要将来一边在知乎哭诉，一边继续做牛马？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"eSPXN30F\"\u003e\u003cb\u003e就不能换个更合适的人？就不能硬气点说老娘不同意？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"DeIQZAyz\"\u003e你何必呢？\u003c/p\u003e\u003cp data-pid=\"LFrLPTF-\"\u003e真的。但凡你说：“我自己觉得他很好，他家很好。虽然其他人说他们不好，我依然觉得很好。”\u003c/p\u003e\u003cp data-pid=\"OOI2R2uY\"\u003e我都不会劝你分手。\u003c/p\u003e\u003cp data-pid=\"yykDRmKJ\"\u003e可你都在知乎哭诉几次了，怎么还死心塌地的要跟着？\u003c/p\u003e\u003cp data-pid=\"L-QgpJaD\"\u003e\u003cb\u003e要么这是习惯性地博取同情，要么就是人很轴，就是好这一口。\u003c/b\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"CucXkNBC\"\u003e不管哪样，都没什么再可以多说的。\u003c/p\u003e\u003cp data-pid=\"9W69ZIM7\"\u003e散了吧都。\u003c/p\u003e",
        "relationship": {
          "is_thanked": false,
          "is_nothelp": false,
          "voting": 0
        },
        "is_labeled": false,
        "visited_count": 6561,
        "thumbnails": [
          "https://pic1.zhimg.com/50/v2-e722ce5fd60830d185527f8d83422e11_720w.jpg?source=b6762063",
          "https://pic1.zhimg.com/50/v2-f1d723cb4c72bb2b71b31fa91f29a739_720w.jpg?source=b6762063",
          "https://picx.zhimg.com/50/v2-532b3b54706fd7a02d015d0302da87d5_720w.jpg?source=b6762063",
          "https://picx.zhimg.com/50/v2-53b27e474ee9f5d09de7f1b8a0036e4f_720w.jpg?source=b6762063"
        ],
        "favorite_count": 4,
        "answer_type": "normal"
      },
      "brief": "{\"source\": \"TS\", \"type\": \"answer\", \"id\": 3201442432}",
      "attached_info": "CsIFCM3ZsNrByc6OngEQBBoJNjEyMTYxNjkyILWB56cGKBgwBEAGSkQKJ1RTX1NPVVJDRV9DT05UUk9MX1NVUFBPUlRfSU5TRVJUX1JBTkRPTRITMjg4MjMwMzc2MTUxODY0NzYxMxgAIAA6AFoJMTAwMjAxNDg3YiAwYTcwZTlmY2VlYjE5NjNjNDY2ZTZhNDhhNmM1NWY2Y3IKMzIwMTQ0MjQzMooBCTYyMDY0Nzk4NKoBCXJlY29tbWVuZMIBIDMyZDNmZDhkZTc2NmRjZmFlNzNkMDE2MTk1NzRlN2U48gEKCAwSBk5vcm1hbPIBKAgKEiQ4Y2YzOTJkMy1jMzFlLTRjMDgtYjlhZi1mMzczOTg5OGNmNTjyAQUICxIBMoICAIgC5+aBmqcxkgIgMzJkM2ZkOGRlNzY2ZGNmYWU3M2QwMTYxOTU3NGU3ZTiaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIbSGlnaExldmVsQ3JlYXRvcldlaWdodFJ1bGU0ygIWRmVlZENvbnRyb2xCcmVha0luUnVsZdoCJ1RTX1NPVVJDRV9DT05UUk9MX1NVUFBPUlRfSU5TRVJUX1JBTkRPTegCA/oCC05PUk1BTF9GTE9XigMgZGQ0ODhiZWJmOTgzNGZjMzgxNDA4NDU4YTVkZjI2NzKaAw0KAnYyEAAaBW90aGVyqAOhM9gDAOoDFWNvbnRlbnRQb29sUHVyZVJhbmRvbfoDEhIMVU5LTk9XTl9NT0RFIABAAIAEAIgEAJIEBk5vcm1hbJoEATOgBACoBACwBAC6BAZtYW51YWzCBAMxNzDIBADSBA/mjqjojZDlt7Lmm7TmlrDYBADgBALwBJDYCPkEAAAAoIbcgz+BBQAAAAAAAAAAiQWQWgq998jrP5IFCeaxn+Wkj+WMupoFA2RmdKIFA2RmdJICJQoJNjEyMTYxNjkyEgozMjAxNDQyNDMyGAQiCklNQUdFX1RFWFQ=",
      "action_card": false
    },
    {
      "id": "7_1694150718.374",
      "type": "feed",
      "offset": 7,
      "verb": "TOPIC_ACKNOWLEDGED_ARTICLE",
      "created_time": 1694150718,
      "updated_time": 1694150718,
      "target": {
        "id": 654786933,
        "type": "article",
        "url": "https://api.zhihu.com/articles/654786933",
        "author": {
          "id": "5a4c7d36a66ba4e6c27704f814dee484",
          "url": "https://api.zhihu.com/people/5a4c7d36a66ba4e6c27704f814dee484",
          "user_type": "people",
          "url_token": "wenfh2020",
          "name": "wenfh2020",
          "headline": "学无止境",
          "avatar_url": "https://picx.zhimg.com/50/v2-790e3195090014455b213ed7599de100_l.jpg?source=b6762063",
          "is_org": false,
          "gender": -1,
          "followers_count": 3024,
          "is_following": false,
          "is_followed": false
        },
        "title": "深入探索 C++ 多态 ③ - 虚析构",
        "image_url": "https://pic1.zhimg.com/v2-c1dd194a273f47874ced0aae99e50d84_720w.jpg?source=7e7ef6e2",
        "comment_permission": "all",
        "created": 1694052021,
        "updated": 1694138633,
        "voteup_count": 6,
        "voting": 0,
        "comment_count": 2,
        "linkbox": {
          "category": "",
          "pic": "",
          "title": "",
          "url": ""
        },
        "excerpt": "前言前两章探索了 C++ 多态的 虚函数调用链路 和 继承关系 ，本章将探索 虚析构 的工作原理。具有虚析构多态特征的类对象，被释放时： 有继承关系的多态类，会先析构派生类，再析构基类，与它的构造顺序刚好相反。类的析构函数被调用时，对象的 this 指针和虚指针会在对应的类内部被重新设置，this 指针指向当前类对象对应的内存位置，虚指针也会被重置指向当前类对应的虚表。释放当前派生类对象内存。文章来源：深入探索 C++ 多…",
        "excerpt_new": "前言前两章探索了 C++ 多态的 虚函数调用链路 和 继承关系 ，本章将探索 虚析构 的工作原理。具有虚析构多态特征的类对象，被释放时： 有继承关系的多态类，会先析构派生类，再析构基类，与它的构造顺序刚好相反。类的析构函数被调用时，对象的 this 指针和虚指针会在对应的类内部被重新设置，this 指针指向当前类对象对应的内存位置，虚指针也会被重置指向当前类对应的虚表。释放当前派生类对象内存。文章来源：深入探索 C++ 多…",
        "preview_type": "default",
        "preview_text": "",
        "column": {
          "id": "c_1451893731637587968",
          "type": "column",
          "url": "https://api.zhihu.com/columns/c_1451893731637587968",
          "author": {
            "id": "",
            "url": "",
            "user_type": "people",
            "url_token": "",
            "name": "匿名用户",
            "headline": "",
            "avatar_url": "https://pic1.zhimg.com/v2-d41c2ceaed8f51999522f903672a521f_l.jpg?source=b6762063",
            "is_org": false,
            "gender": -1,
            "followers_count": 0,
            "is_following": false,
            "is_followed": false
          },
          "title": "c/c++",
          "imageUrl": "https://pic1.zhimg.com/4b70deef7_720w.jpg?source=d16d100b",
          "comment_permission": "private",
          "intro": "收录个人 c/c++ 相关内容。",
          "updated": 1638938440,
          "is_following": false
        },
        "content": "\u003ch2\u003e前言\u003c/h2\u003e\u003cp data-pid=\"rYn-4RVP\"\u003e前两章探索了 C++ 多态的 \u003ca href=\"https://zhuanlan.zhihu.com/p/652010216\" class=\"internal\"\u003e虚函数调用链路\u003c/a\u003e 和 \u003ca href=\"https://zhuanlan.zhihu.com/p/652010216\" class=\"internal\"\u003e继承关系\u003c/a\u003e，本章将探索 \u003ccode\u003e虚析构\u003c/code\u003e 的工作原理。\u003c/p\u003e\u003cp data-pid=\"eVoAid5T\"\u003e具有虚析构多态特征的类对象，被释放时：\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"M03ffkuY\"\u003e有继承关系的多态类，会先析构派生类，再析构基类，与它的构造顺序刚好相反。\u003c/li\u003e\u003cli data-pid=\"-8bC4MoI\"\u003e类的析构函数被调用时，对象的 this 指针和虚指针会在对应的类内部被重新设置，this 指针指向当前类对象对应的内存位置，虚指针也会被重置指向当前类对应的虚表。\u003c/li\u003e\u003cli data-pid=\"rwyo4ZxI\"\u003e释放当前派生类对象内存。\u003c/li\u003e\u003c/ul\u003e\u003cblockquote data-pid=\"qRr8lcJD\"\u003e文章来源：\u003ca href=\"https://link.zhihu.com/?target=https%3A//wenfh2020.com/2023/08/25/cpp-destructor/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e深入探索 C++ 多态 ③ - 虚析构\u003c/a\u003e\u003c/blockquote\u003e\u003ch2\u003e1. 概述\u003c/h2\u003e\u003ch3\u003e1.1. 概念\u003c/h3\u003e\u003cp data-pid=\"V7HQpfaX\"\u003eC++ 虚析构函数是在 C++ 中用于处理继承关系的特殊函数。它允许在基类中定义一个虚析构函数，以便在派生类对象被删除时正确地释放资源。虚析构函数的声明方式是在基类的析构函数前面加上关键字 “virtual”。\u003c/p\u003e\u003cp data-pid=\"lzzEZNQv\"\u003e当释放基类指针指向派生类的对象时，如果基类中的析构函数不是虚函数，那么只会调用基类的析构函数，而不会调用派生类的析构函数。这可能导致资源泄漏或未定义的行为。\u003c/p\u003e\u003cp data-pid=\"43OUmeEY\"\u003e通过将基类的析构函数声明为虚函数，可以确保在删除派生类对象时，会首先调用派生类的析构函数，然后再调用基类的析构函数，从而正确地释放所有相关资源。\u003c/p\u003e\u003cblockquote data-pid=\"sACLgEXb\"\u003e部分文字来源：ChatGPT\u003c/blockquote\u003e\u003ch3\u003e1.2. 析构函数类型\u003c/h3\u003e\u003cp data-pid=\"MRjz9MbP\"\u003e要理解 C++ 虚析构函数，我们需要了解一些概念，编译器会根据不同的场景，生成不同类型的析构函数供程序进行调用。这些概念下面实例将会提到。\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"1pVLQQFp\"\u003ebase object destructor of a class T\u003cbr/\u003eA function that runs the destructors for non-static data members of T and non-virtual direct base classes of T.\u003c/li\u003e\u003cli data-pid=\"rjZaLuyT\"\u003ecomplete object destructor of a class T\u003cbr/\u003eA function that, in addition to the actions required of a base object destructor, runs the destructors for the virtual base classes of T.\u003c/li\u003e\u003cli data-pid=\"oCDFlsnn\"\u003edeleting destructor of a class T\u003cbr/\u003eA function that, in addition to the actions required of a complete object destructor, calls the appropriate deallocation function (i.e,. operator delete) for T.\u003c/li\u003e\u003c/ul\u003e\u003cblockquote data-pid=\"g9rHostF\"\u003e文字来源：\u003ca href=\"https://link.zhihu.com/?target=https%3A//itanium-cxx-abi.github.io/cxx-abi/abi.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eItanium C++ ABI\u003c/a\u003e\u003c/blockquote\u003e\u003chr/\u003e\u003cul\u003e\u003cli data-pid=\"HodA731F\"\u003e\u003cb\u003e[base object destructor]\u003c/b\u003e：它销毁对象本身，以及数据成员和非虚基类。\u003c/li\u003e\u003cli data-pid=\"o8_YvxaE\"\u003e\u003cb\u003e[complete object destructor]\u003c/b\u003e：除了执行 [base object destructor]，它还会销毁虚拟基类。\u003c/li\u003e\u003cli data-pid=\"sROoVyMu\"\u003e\u003cb\u003e[deleting object destructor]\u003c/b\u003e：除了执行 [deleting object destructor]，它还调用 operator delete 来实际释放内存。\u003c/li\u003e\u003c/ul\u003e\u003cblockquote data-pid=\"pwnyIUEF\"\u003e【注意】如果没有虚拟基类，[complete object destructor] 和 [base object destructor] 基本是相同的。部分文字来源：\u003ca href=\"https://link.zhihu.com/?target=https%3A//stackoverflow.com/questions/6613870/gnu-gcc-g-why-does-it-generate-multiple-dtors/6614369%236614369\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eGNU GCC (g++): Why does it generate multiple dtors?\u003c/a\u003e\u003c/blockquote\u003e\u003ch2\u003e2. 单一继承\u003c/h2\u003e\u003cp data-pid=\"Blk6swuD\"\u003e通过单一继承，我们来观察一下普通析构和虚析构代码产生的结果。\u003c/p\u003e\u003ch3\u003e2.1. 非虚析构\u003c/h3\u003e\u003ch3\u003e2.1.1. 测试源码\u003c/h3\u003e\u003cp data-pid=\"FqNUFWU9\"\u003e下面测试代码，Derived 类的析构函数没有执行。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"cm\"\u003e/* g++ -O0 -std=c++11 test.cpp -o test */\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x11\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase2\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base2_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x21\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDerived\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase2\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_derived_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x31\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edelete\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 输出：\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base2\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e2.1.2. 析构流程\u003c/h3\u003e\u003cp data-pid=\"-WIMSd6Y\"\u003e接下来，我们使用工具（\u003ca href=\"https://link.zhihu.com/?target=https%3A//godbolt.org/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eCompiler Explorer\u003c/a\u003e），查看源码的汇编实现，这样可以清晰地看到 C++ 源码的内部逻辑：编译器并没有为 Derived 类生成任何关于 ~Derived 析构函数的逻辑。\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"yuUhE5LR\"\u003e析构流程。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e-- main\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- ...\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- delete b\n        \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*, unsigned long\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\u003cli data-pid=\"TGtH9La0\"\u003e汇编源码。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003emain:\n        ...\n        \u003cspan class=\"c1\"\u003e# 析构 Base2 类对象\u003c/span\u003e\n        call    Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n        \u003cspan class=\"c1\"\u003e# delete 对象\u003c/span\u003e\n        call    operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*, unsigned long\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\nBase2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        call    Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n\nBase::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e2.2. 虚析构\u003c/h3\u003e\u003cp data-pid=\"klnVnxET\"\u003e我们在基类 ~Base（或在 ~Base2）析构函数前添加 \u003ccode\u003evirtual\u003c/code\u003e 关键字，程序运行结果符合预期。\u003c/p\u003e\u003ch3\u003e2.2.1. 测试源码\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"cm\"\u003e/* g++ -O0 -std=c++11 -fdump-class-hierarchy test.cpp -o test */\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x11\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase2\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base2_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x21\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDerived\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase2\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_derived_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x31\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edelete\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 输出：\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Derived\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base2\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e2.2.2. 析构流程\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"NBlDF_HO\"\u003e析构流程。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e-- main\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- ...\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- delete b\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 程序调用虚表上的虚析构函数。\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 调用 Derived 析构函数。\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 调用 Base2 析构函数。\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 调用 Base 析构函数。\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# delete 释放对象。\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col\u003e\u003cli data-pid=\"tQpUMuVD\"\u003e程序通过虚指针找到虚表，虚指针指向虚表的位置向高位偏移 8 个字节，找到对应的虚函数：Derived::~Derived() [deleting destructor] 进行调用，接着调用 Derived::~Derived() [complete object destructor] 开始析构对象。\u003c/li\u003e\u003cli data-pid=\"FYSdXhpu\"\u003eDerived::~Derived() [complete object destructor] 内部调用 Base2::~Base2() [base object destructor] 对 Base2 类进行析构，并将虚指针指向 Base2 虚表。\u003c/li\u003e\u003cli data-pid=\"B3C1Q9EV\"\u003eBase2::~Base2() [base object destructor] 内部调用 Base::~Base() [base object destructor] 对 Base 类进行析构，并将虚指针指向 Base 虚表。\u003c/li\u003e\u003cli data-pid=\"GQ-3KrJV\"\u003e各个类的析构函数都调用完毕后，程序调用 delete 操作符，释放 Derived 对象。\u003c/li\u003e\u003c/ol\u003e\u003cblockquote data-pid=\"RlLGMXxY\"\u003e这里的 [complete object destructor] 和 [base object destructor] 类型的析构函数，没有区别，都指向了相同的函数。\u003c/blockquote\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-705d62ed03c4244ebe1099a7650b49f4_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2196\" data-rawheight=\"1580\" data-original-token=\"v2-28bd2d669058872cf1c6f8a02b3a1267\" class=\"origin_image zh-lightbox-thumb\" width=\"2196\" data-original=\"https://pica.zhimg.com/v2-705d62ed03c4244ebe1099a7650b49f4_r.jpg\"/\u003e\u003c/figure\u003e\u003cul\u003e\u003cli data-pid=\"DXmtK12e\"\u003e汇编源码。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003emain:\n        ...\n        call    operator new\u003cspan class=\"o\"\u003e(\u003c/span\u003eunsigned long\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\n        call    Derived::Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object constructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n        \u003cspan class=\"c1\"\u003e# 对象内存首位保存了虚指针。\u003c/span\u003e\n        movq    -32\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 虚指针指向虚表。\u003c/span\u003e\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 程序通过偏移在虚表上找到对应虚函数。\u003c/span\u003e\n        addq    \u003cspan class=\"nv\"\u003e$8\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 保存虚函数地址。\u003c/span\u003e\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 将对象的 this 指针，写入寄存器，作为参数，传递给虚函数。\u003c/span\u003e\n        movq    -32\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rdx\n        movq    %rdx, %rdi\n        \u003cspan class=\"c1\"\u003e# 调用析构函数的虚函数（Derived::~Derived() [deleting destructor]）。\u003c/span\u003e\n        call    *%rax\n\n\u003cspan class=\"c1\"\u003e# 程序通过虚指针找到虚表上的虚函数。\u003c/span\u003e\nDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 调用 Derived 析构函数。\u003c/span\u003e\n        call    Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n        \u003cspan class=\"c1\"\u003e# 调用 delete 释放对象。\u003c/span\u003e\n        call    operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\n\nDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 虚指针指向 Derived 虚表。\u003c/span\u003e\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+16, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 调用 Base2 析构函数。\u003c/span\u003e\n        call    Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n\nBase2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 虚指针指向 Base2 虚表。\u003c/span\u003e\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2+16, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 调用 Base 析构函数。\u003c/span\u003e\n        call    Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n\nBase::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 虚指针指向 Base 虚表。\u003c/span\u003e\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base+16, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\n\n\u003cspan class=\"c1\"\u003e# Derived 虚表。\u003c/span\u003e\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived:\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived\n        .quad   Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# main 函数调用 delete 操作符时，调用 [deleting destructor] 类型的析构函数。\u003c/span\u003e\n        .quad   Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Base2 虚表。\u003c/span\u003e\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2:\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2\n        .quad   Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Base 虚表。\u003c/span\u003e\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base:\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base\n        .quad   Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e 3. 多重继承\u003c/h2\u003e\u003ch3\u003e3.1. 测试代码\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"cm\"\u003e/* g++ -O0 -std=c++11 -fdump-class-hierarchy test.cpp -o test */\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x11\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase2\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base2_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x21\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDerived\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase2\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_derived_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x31\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edelete\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 输出：\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Derived\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base2\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e3.2. 析构流程\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"ZPRXFYZV\"\u003e析构流程。详细逻辑，结合汇编源码和图片去理解吧。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e-- main\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- ...\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- delete b\n        \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- non-virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-c85ae1ff27d8e582a2b0514a5e119778_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2108\" data-rawheight=\"1874\" data-original-token=\"v2-86f610f3baac7918538117c3768d667a\" class=\"origin_image zh-lightbox-thumb\" width=\"2108\" data-original=\"https://pic3.zhimg.com/v2-c85ae1ff27d8e582a2b0514a5e119778_r.jpg\"/\u003e\u003c/figure\u003e\u003cul\u003e\u003cli data-pid=\"Ij2LG52F\"\u003e汇编。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003emain:\n        ...\n        \u003cspan class=\"c1\"\u003e# 虚指针 vptr2 指向虚表。\u003c/span\u003e\n        movq    -32\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 在虚表上进行偏移，找到对应的虚析构函数。\u003c/span\u003e\n        addq    \u003cspan class=\"nv\"\u003e$8\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 将 b 指针指向的地址传递给虚析构函数作为函数参数。\u003c/span\u003e\n        movq    -32\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rdx\n        movq    %rdx, %rdi\n        \u003cspan class=\"c1\"\u003e# 调用（non-virtual thunk to Derived::~Derived() [deleting destructor]）。\u003c/span\u003e\n        call    *%rax\n\n\u003cspan class=\"c1\"\u003e# delete 操作符触发调用的虚析构函数，跳转到 Derived::~Derived() [deleting destructor]\u003c/span\u003e\nnon-virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        \u003cspan class=\"c1\"\u003e# 通过偏移，对象内存首地址传给 Derived::~Derived() [deleting destructor]。\u003c/span\u003e\n        subq    \u003cspan class=\"nv\"\u003e$16\u003c/span\u003e, %rdi\n        jmp     .LTHUNK1\n\n\u003cspan class=\"c1\"\u003e# delete Derived 虚析构函数。\u003c/span\u003e\nDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 将 Derived 对象的 this 指针作为参数传给 Derived 析构函数。\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rax, %rdi\n        \u003cspan class=\"c1\"\u003e# 调用 Derived 析构函数。\u003c/span\u003e\n        call    Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 将 Derived 的 this 指针作为参数传给 delete 操作函数。\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rax, %rdi\n        \u003cspan class=\"c1\"\u003e# 调用 delete 释放 Derived 对象。\u003c/span\u003e\n        call    operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\n\nDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# vptr1 指向 Derived 虚表对应位置。\u003c/span\u003e\n        movq    %rdi, -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+16, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# vptr2 指向 Derived 虚表对应位置。\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+48, 16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 将 b 指针指向的地址传给 Base2 析构函数。\u003c/span\u003e\n        addq    \u003cspan class=\"nv\"\u003e$16\u003c/span\u003e, %rax\n        movq    %rax, %rdi\n        \u003cspan class=\"c1\"\u003e# 调用 Base2 对象析构函数。\u003c/span\u003e\n        call    Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 将 Derived 对象首地址传给 Base 析构函数。\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rax, %rdi\n        \u003cspan class=\"c1\"\u003e# 调用 Base 对象析构函数。\u003c/span\u003e\n        call    Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n\nBase2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# vptr2 指向 Base2 虚表。\u003c/span\u003e\n        movq    %rdi, -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2+16, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\n\nBase::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# vptr1 指向 Base 虚表。\u003c/span\u003e\n        movq    %rdi, -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base+16, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\n\n\u003cspan class=\"c1\"\u003e# 类虚表。\u003c/span\u003e\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived:\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived\n        .quad   Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# delete 操作符调用的虚析构函数。\u003c/span\u003e\n        .quad   Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   -16\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived\n        .quad   non-virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   non-virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2:\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2\n        .quad   Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base:\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base\n        .quad   Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e4. 虚拟继承\u003c/h2\u003e\u003ch3\u003e4.1. 测试代码\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"cm\"\u003e/* g++ -O0 -std=c++11 -fdump-class-hierarchy test.cpp -o test */\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x11\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase2\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base2_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x21\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase3\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eBase3\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_base2_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x31\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDerived\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBase3\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003epublic\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e__FUNCTION__\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eendl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003em_derived_data\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x41\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDerived\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBase\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edelete\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 输出：\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Derived\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base3\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base2\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// ~Base\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e4.2. 对象内存布局\u003c/h3\u003e\u003cp data-pid=\"U62sRz1l\"\u003e我们先来看看 Derived 整体的对象内存布局特点：\u003c/p\u003e\u003col\u003e\u003cli data-pid=\"nVIVinWW\"\u003e共享基类的数据存储于对象内存底部。\u003c/li\u003e\u003cli data-pid=\"N1qyc1tl\"\u003e编译器为虚拟继承增加了一个 VTT (virtual table table)，它协调构造出了 Derived 的虚表（详看下图）。\u003c/li\u003e\u003c/ol\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-462fb2bafaa42f18f8558ac2f9ac85dc_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2522\" data-rawheight=\"1884\" data-original-token=\"v2-2033e14917c218aee5d0985262150d88\" class=\"origin_image zh-lightbox-thumb\" width=\"2522\" data-original=\"https://pic3.zhimg.com/v2-462fb2bafaa42f18f8558ac2f9ac85dc_r.jpg\"/\u003e\u003c/figure\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"c1\"\u003e# Derived 虚表\u003c/span\u003e\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived:\n        .quad   \u003cspan class=\"m\"\u003e40\u003c/span\u003e\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived\n        .quad   Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   \u003cspan class=\"m\"\u003e24\u003c/span\u003e\n        .quad   -16\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived\n        .quad   non-virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   non-virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   -40\n        .quad   -40\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived\n        .quad   virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# virtual table table。\u003c/span\u003e\nVTT \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived:\n        .quad   vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+24\n        .quad   construction vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2-in-Derived+24\n        .quad   construction vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2-in-Derived+64\n        .quad   construction vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base3-in-Derived+24\n        .quad   construction vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base3-in-Derived+64\n        .quad   vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+104\n        .quad   vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+64\n\nconstruction vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2-in-Derived:\n        .quad   \u003cspan class=\"m\"\u003e40\u003c/span\u003e\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2\n        .quad   Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   -40\n        .quad   -40\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base2\n        .quad   virtual thunk to Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   virtual thunk to Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\nconstruction vtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base3-in-Derived:\n        .quad   \u003cspan class=\"m\"\u003e24\u003c/span\u003e\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base3\n        .quad   Base3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Base3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   -24\n        .quad   -24\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base3\n        .quad   virtual thunk to Base3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   virtual thunk to Base3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e4.3. 析构流程\u003c/h3\u003e\u003cp data-pid=\"zDh8xzNS\"\u003e虽然虚拟继承内存布局有一些特殊，但对象的整体析构流程与其它继承关系的对象析构流程并没有多大区别。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e-- main\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- ...\n    \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- delete b\n        \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- virtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u003c/span\u003e-- operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\u003cli data-pid=\"jLUERUKX\"\u003e调用 ~Derived() 析构函数。\u003c/li\u003e\u003c/ul\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-5ac41070d2202dfa2db78d1faca691cc_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2454\" data-rawheight=\"1550\" data-original-token=\"v2-d6ed0920a2622fd7e7ef1e67d172a625\" class=\"origin_image zh-lightbox-thumb\" width=\"2454\" data-original=\"https://pica.zhimg.com/v2-5ac41070d2202dfa2db78d1faca691cc_r.jpg\"/\u003e\u003c/figure\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003emain:\n        ...\n        \u003cspan class=\"c1\"\u003e# 虚指针 vptr3 指向虚表。\u003c/span\u003e\n        movq    -32\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 在虚表上偏移找到对应虚函数地址：\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# virtual thunk to Derived::~Derived() [deleting destructor]。\u003c/span\u003e\n        addq    \u003cspan class=\"nv\"\u003e$8\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        \u003cspan class=\"c1\"\u003e# 将 b 指针，作为参数，传递给将要被调用的虚函数。\u003c/span\u003e\n        movq    -32\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rdx\n        movq    %rdx, %rdi\n        \u003cspan class=\"c1\"\u003e# 程序调用前面找到的虚函数。\u003c/span\u003e\n        call    *%rax\n        ...\n\n\u003cspan class=\"c1\"\u003e# 主程序 \u0026#34;call *%rax\u0026#34; 指令调用的虚函数。\u003c/span\u003e\nvirtual thunk to Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e:\n        \u003cspan class=\"c1\"\u003e# 虚指针指向虚表的的位置，该位置向低地址偏移 24 个字节。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 获取该地址的内存偏移量 -40，对象 this 指针向低地址偏移 40 个字节。\u003c/span\u003e\n        mov    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rdi\u003cspan class=\"o\"\u003e)\u003c/span\u003e,%r10\n        add    -0x18\u003cspan class=\"o\"\u003e(\u003c/span\u003e%r10\u003cspan class=\"o\"\u003e)\u003c/span\u003e,%rdi\n        \u003cspan class=\"c1\"\u003e# 调用 Derived::~Derived() [deleting destructor]\u003c/span\u003e\n        jmp    \u003cspan class=\"m\"\u003e401488\u003c/span\u003e \u0026lt;Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u0026gt;\n\n\nDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 调用 Derived 对象析构函数。\u003c/span\u003e\n        call    Derived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n        \u003cspan class=\"c1\"\u003e# 调用 delete 释放对象。\u003c/span\u003e\n        call    operator delete\u003cspan class=\"o\"\u003e(\u003c/span\u003evoid*\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        leave\n        ret \n\n\u003cspan class=\"c1\"\u003e# Derived 完全对象析构函数，重置对象的 this 指针和虚指针，虚指针指向对应的虚表。\u003c/span\u003e\nDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# this 指针指向内存首位。\u003c/span\u003e\n        movq    %rdi, -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 重置 Derived 对象虚指针，指向 Derived 虚表对应位置。\u003c/span\u003e\n        movl    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+24, %edx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rdx, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movl    \u003cspan class=\"nv\"\u003e$40\u003c/span\u003e, %edx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        addq    %rax, %rdx\n        movl    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+104, %eax\n        movq    %rax, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rdx\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movl    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+64, %edx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rdx, 16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e# 调整 this 指针，从 VTT 中找到保存 Base3 虚函数地址的位置，准备重置 Base3 的虚指针。\u003c/span\u003e\n        movl    \u003cspan class=\"nv\"\u003e$VTT\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+24, %eax\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rdx\n        addq    \u003cspan class=\"nv\"\u003e$16\u003c/span\u003e, %rdx\n        movq    %rax, %rsi\n        movq    %rdx, %rdi\n        call    Base3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e# 调整 this 指针，从 VTT 中找到保存 Base2 虚函数地址的位置，准备重置 Base2 的虚指针。\u003c/span\u003e\n        movl    \u003cspan class=\"nv\"\u003e$VTT\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+8, %edx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rdx, %rsi\n        movq    %rax, %rdi\n        call    Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n        \n        \u003cspan class=\"c1\"\u003e# 调整 this 指针，重置 Base 虚指针\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        addq    \u003cspan class=\"nv\"\u003e$40\u003c/span\u003e, %rax\n        movq    %rax, %rdi\n        call    Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\u003cli data-pid=\"14gvMTjM\"\u003e~Base3() 析构函数。\u003c/li\u003e\u003c/ul\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-7ae0d625c298fee7fbd4a9e858c3db70_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2668\" data-rawheight=\"1860\" data-original-token=\"v2-537481c1b8dd607762a08fc378d33cfe\" class=\"origin_image zh-lightbox-thumb\" width=\"2668\" data-original=\"https://pica.zhimg.com/v2-7ae0d625c298fee7fbd4a9e858c3db70_r.jpg\"/\u003e\u003c/figure\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 调整 this 指针，从 VTT 中找到保存 Base3 虚函数地址的位置，准备重置 Base3 的虚指针。\u003c/span\u003e\n        movl    \u003cspan class=\"nv\"\u003e$VTT\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+24, %eax\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rdx\n        addq    \u003cspan class=\"nv\"\u003e$16\u003c/span\u003e, %rdx\n        movq    %rax, %rsi\n        movq    %rdx, %rdi\n        call    Base3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\nBase3::~Base3\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        movq    %rdi, -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movq    %rsi, -16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 虚指针 vptr2 指向虚表对应位置。\u003c/span\u003e\n        movq    -16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rdx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rdx, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e# 通过虚表偏移找到 vbase_offset\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        subq    \u003cspan class=\"nv\"\u003e$24\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n\n        \u003cspan class=\"c1\"\u003e# 虚指针 vptr3 指向虚表对应位置。\u003c/span\u003e\n        movq    %rax, %rdx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        addq    %rax, %rdx\n        movq    -16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rax, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rdx\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\u003cli data-pid=\"nU4_h4oL\"\u003e~Base2() 析构函数。\u003c/li\u003e\u003c/ul\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-7ae0d625c298fee7fbd4a9e858c3db70_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2668\" data-rawheight=\"1860\" data-original-token=\"v2-537481c1b8dd607762a08fc378d33cfe\" class=\"origin_image zh-lightbox-thumb\" width=\"2668\" data-original=\"https://pica.zhimg.com/v2-7ae0d625c298fee7fbd4a9e858c3db70_r.jpg\"/\u003e\u003c/figure\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"c1\"\u003e# Derived 完全对象析构函数，重置对象的 this 指针和虚指针，虚指针指向对应的虚表。\u003c/span\u003e\nDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 调整 this 指针，从 VTT 中找到保存 Base2 虚函数地址的位置，准备重置 Base2 的虚指针。\u003c/span\u003e\n        movl    \u003cspan class=\"nv\"\u003e$VTT\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Derived+8, %edx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rdx, %rsi\n        movq    %rax, %rdi\n        call    Base2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\nBase2::~Base2\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        movq    %rdi, -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movq    %rsi, -16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 虚指针 vptr1 指向虚表（Construction vtable for Base2 in Derived）对应位置。\u003c/span\u003e\n        movq    -16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rdx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rdx, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e# 通过虚表偏移找到 vbase_offset\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        subq    \u003cspan class=\"nv\"\u003e$24\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n\n        \u003cspan class=\"c1\"\u003e# 虚指针 vptr3 指向虚表对应位置。\u003c/span\u003e\n        movq    %rax, %rdx\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        addq    %rax, %rdx\n        movq    -16\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    %rax, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rdx\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\u003cli data-pid=\"eSnyiFOo\"\u003e~Base() 析构函数。\u003c/li\u003e\u003c/ul\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-108b06c732cbd4f8f46d5c778875d4f2_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2456\" data-rawheight=\"1216\" data-original-token=\"v2-b0fe453fc896da06a60411608a712901\" class=\"origin_image zh-lightbox-thumb\" width=\"2456\" data-original=\"https://pic1.zhimg.com/v2-108b06c732cbd4f8f46d5c778875d4f2_r.jpg\"/\u003e\u003c/figure\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eDerived::~Derived\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        \u003cspan class=\"c1\"\u003e# 调整 this 指针，重置 Base 虚指针。\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        addq    \u003cspan class=\"nv\"\u003e$40\u003c/span\u003e, %rax\n        movq    %rax, %rdi\n        call    Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        ...\n\nBase::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n        ...\n        movq    %rdi, -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        movq    -8\u003cspan class=\"o\"\u003e(\u003c/span\u003e%rbp\u003cspan class=\"o\"\u003e)\u003c/span\u003e, %rax\n        movq    \u003cspan class=\"nv\"\u003e$vtable\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base+16, \u003cspan class=\"o\"\u003e(\u003c/span\u003e%rax\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        ...\n\nvtable \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base:\n        .quad   \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        .quad   typeinfo \u003cspan class=\"k\"\u003efor\u003c/span\u003e Base\n        .quad   Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e object destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n        .quad   Base::~Base\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edeleting destructor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e5. 小结\u003c/h2\u003e\u003cul\u003e\u003cli data-pid=\"gXit65ku\"\u003e虚析构工作原理，还是那几个关键点：虚指针，虚表，虚函数，还有每个类内部 this 指针的变化。\u003c/li\u003e\u003cli data-pid=\"myHgdZZs\"\u003e虽然多态类的虚函数和虚表是在程序运行前，编译器已经生成，但是多态对象在创建构造的过程中，对象内存数据是按顺序构造出来的（先构造基类，再构造派生类），因此每个构造环节，当前类的 this 指针和 虚指针都可能会出现变化，同理派生类对象的析构，顺序刚好与构造顺序相反（先析构派生类，再析构基类），当然 this 指针和 虚指针，也会像构造那样可能出现相应变化。\u003c/li\u003e\u003cli data-pid=\"hO-c7i-Y\"\u003e虚析构虽然使用简单，如果用户忘记使用虚析构，在销毁对象时，可能导致派生类的析构函数不被调用，这是始料未及的。友好的语言应该将复杂的事情变得简单，C++ 这门语言，显然还有很大的优化空间。\u003c/li\u003e\u003c/ul\u003e\u003ch2\u003e6. 引用\u003c/h2\u003e\u003cul\u003e\u003cli data-pid=\"IoY8TYB5\"\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//itanium-cxx-abi.github.io/cxx-abi/abi.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eItanium C++ ABI\u003c/a\u003e\u003c/li\u003e\u003cli data-pid=\"liTirCJq\"\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//stackoverflow.com/questions/6613870/gnu-gcc-g-why-does-it-generate-multiple-dtors/6614369%236614369\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eGNU GCC (g++): Why does it generate multiple dtors?\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e",
        "is_labeled": false,
        "visited_count": 580,
        "thumbnails": [
          "https://pic1.zhimg.com/v2-c1dd194a273f47874ced0aae99e50d84_720w.jpg?source=7e7ef6e2",
          "https://pic1.zhimg.com/50/v2-35f4bb917cd89ccf3c6e2e19bf1d6191_720w.jpg?source=b6762063",
          "https://picx.zhimg.com/50/v2-0ba182f2e49625c10070b0a64d8f2987_720w.jpg?source=b6762063",
          "https://picx.zhimg.com/50/v2-d72affc29b96f85ab45a124e95df5120_720w.jpg?source=b6762063",
          "https://picx.zhimg.com/50/v2-93b6d78d35fd948e3d695a35f7a5f790_720w.jpg?source=b6762063",
          "https://picx.zhimg.com/50/v2-99eb9c54e08f47a0c808397758e5eb4d_720w.jpg?source=b6762063",
          "https://pic1.zhimg.com/50/v2-99eb9c54e08f47a0c808397758e5eb4d_720w.jpg?source=b6762063",
          "https://pica.zhimg.com/50/v2-542774712cd90f626979cee4daaa5eae_720w.jpg?source=b6762063",
          "https://pic1.zhimg.com/50/v2-0ba182f2e49625c10070b0a64d8f2987_720w.jpg?source=b6762063"
        ],
        "favorite_count": 77
      },
      "brief": "{\"source\": \"TS\", \"type\": \"article\", \"id\": 654786933}",
      "attached_info": "CokGCM3ZsNrByc6OngEQBxoJMjMzNjM2ODI5ILXd5KcGKAYwAkAHSiMKGFRTX1NPVVJDRV9XQVJNX1VQX0JPT1NUMRIBMBgAIAA6AEoiChdUU19TT1VSQ0VfV0FSTVVQX1JVQ0VORRIBMBgAIAA6AEooChNUU19TT1VSQ0VfRkVFRFJFX1Y3EgEwGAAgADoKeyJyYXciOiIifVoIMTI4NjkxOTZiIDBhNzBlOWZjZWViMTk2M2M0NjZlNmE0OGE2YzU1ZjZjcgk2NTQ3ODY5MzOCAVNodHRwczovL3BpYzEuemhpbWcuY29tL3YyLWMxZGQxOTRhMjczZjQ3ODc0Y2VkMGFhZTk5ZTUwZDg0XzcyMHcuanBnP3NvdXJjZT03ZTdlZjZlMooBFWNfMTQ1MTg5MzczMTYzNzU4Nzk2OKoBCXJlY29tbWVuZMIBIDVhNGM3ZDM2YTY2YmE0ZTZjMjc3MDRmODE0ZGVlNDg08gEKCAwSBk5vcm1hbPIBKAgKEiRmNmI5OGQyOS04ZTM2LTRmNmEtYTU1OS03NjUxYTZlODI2ZGLyAQUICxIBMoICAIgC6OaBmqcxkgIgNWE0YzdkMzZhNjZiYTRlNmMyNzcwNGY4MTRkZWU0ODSaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIbSGlnaExldmVsQ3JlYXRvcldlaWdodFJ1bGUz2gIYVFNfU09VUkNFX1dBUk1fVVBfQk9PU1Qx6AID+gILTk9STUFMX0ZMT1eKAyBkZDQ4OGJlYmY5ODM0ZmMzODE0MDg0NThhNWRmMjY3MpoDDQoCdjIQABoFb3RoZXKoA8QE2AMA+gMSEgxVTktOT1dOX01PREUgAEAAgAQAiAQAkgQGTm9ybWFsmgQBM6AEAKgEALAEALoEAmFpwgQDNDAwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA4AQC8AQA+QQAAADAF5OmP4EFAAAAAAAAAACJBZBaCr33yOs/kgUJ5rGf5aSP5Yy6mgUDZGZ0ogUDZGZ0kgIkCgkyMzM2MzY4MjkSCTY1NDc4NjkzMxgHIgpJTUFHRV9URVhU",
      "action_card": false
    },
    {
      "id": "8_1694150718.307",
      "type": "feed",
      "offset": 8,
      "verb": "TOPIC_ACKNOWLEDGED_ARTICLE",
      "created_time": 1694150718,
      "updated_time": 1694150718,
      "target": {
        "id": 650219347,
        "type": "article",
        "url": "https://api.zhihu.com/articles/650219347",
        "author": {
          "id": "3f5712d4967eb233a4e0f1908f19a182",
          "url": "https://api.zhihu.com/people/3f5712d4967eb233a4e0f1908f19a182",
          "user_type": "people",
          "url_token": "guang-dian-ke-ji-jun",
          "name": "光电科技君",
          "headline": "发现不一样的科技 公众号：老陈聊科学",
          "avatar_url": "https://picx.zhimg.com/50/v2-ccbda4f757ea026ff61fb497728d1451_l.jpg?source=b6762063",
          "is_org": false,
          "gender": 1,
          "followers_count": 6679,
          "is_following": false,
          "is_followed": false
        },
        "title": "中国发现102.3米巨型高树，什么力量把水“抽”上百米高的树梢？",
        "comment_permission": "all",
        "created": 1692094985,
        "updated": 1692094985,
        "voteup_count": 1182,
        "voting": 0,
        "comment_count": 74,
        "linkbox": {
          "category": "",
          "pic": "",
          "title": "",
          "url": ""
        },
        "excerpt": "100多米的大树，即便安装一个100米扬程的水泵，也要考虑1MPa给管件带来的强大压力，更不要说动力来源了。 1个大气压最多能支持10米高的水柱，根压不行，毛细现象也无能为力， 唯有西藏柏木强大的蒸腾作用，才具有如此强悍的拉动力。加上雅鲁藏布江大峡谷的雾气和雨水，才最终造就了百米大树。 与美国动辄百米的红杉树相比，西藏柏木与其同属于柏科，都是乔木。而因为不同属，它们的叶子差异很大，但是都具有强大的水分吸收能力…",
        "excerpt_new": "100多米的大树，即便安装一个100米扬程的水泵，也要考虑1MPa给管件带来的强大压力，更不要说动力来源了。 1个大气压最多能支持10米高的水柱，根压不行，毛细现象也无能为力， 唯有西藏柏木强大的蒸腾作用，才具有如此强悍的拉动力。加上雅鲁藏布江大峡谷的雾气和雨水，才最终造就了百米大树。 与美国动辄百米的红杉树相比，西藏柏木与其同属于柏科，都是乔木。而因为不同属，它们的叶子差异很大，但是都具有强大的水分吸收能力…",
        "preview_type": "default",
        "preview_text": "",
        "column": {
          "id": "c_1572177642505420800",
          "type": "column",
          "url": "https://api.zhihu.com/columns/c_1572177642505420800",
          "author": {
            "id": "",
            "url": "",
            "user_type": "people",
            "url_token": "",
            "name": "匿名用户",
            "headline": "",
            "avatar_url": "https://pica.zhimg.com/v2-d41c2ceaed8f51999522f903672a521f_l.jpg?source=b6762063",
            "is_org": false,
            "gender": -1,
            "followers_count": 0,
            "is_following": false,
            "is_followed": false
          },
          "title": "胡侃不瞎说",
          "imageUrl": "https://picx.zhimg.com/4b70deef7_720w.jpg?source=d16d100b",
          "comment_permission": "private",
          "intro": "不一样的视角解读科技、科学，有时也八卦",
          "updated": 1667616359,
          "is_following": false
        },
        "content": "\u003cp data-pid=\"gGLd98eF\"\u003e100多米的大树，即便安装一个100米扬程的水泵，也要考虑1MPa给管件带来的强大压力，更不要说动力来源了。\u003c/p\u003e\u003cp data-pid=\"fQxiV8zG\"\u003e1个大气压最多能支持10米高的水柱，根压不行，毛细现象也无能为力，\u003cb\u003e唯有西藏柏木强大的蒸腾作用，才具有如此强悍的拉动力。加上雅鲁藏布江大峡谷的雾气和雨水，才最终造就了百米大树。\u003c/b\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-94390d55b5b89f28e292470aaf36a0ff_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"550\" data-rawheight=\"977\" data-original-token=\"v2-20cb21be1f79896ccec2dfc452821987\" class=\"origin_image zh-lightbox-thumb\" width=\"550\" data-original=\"https://pic2.zhimg.com/v2-94390d55b5b89f28e292470aaf36a0ff_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"VP2a1ZnN\"\u003e与美国动辄百米的红杉树相比，西藏柏木与其同属于柏科，都是乔木。而因为不同属，它们的叶子差异很大，但是都具有强大的水分吸收能力，这也就是其能长高的秘密。\u003c/p\u003e\u003cp data-pid=\"Cl7Jm1My\"\u003e我们知道，树木顶端想要从土壤中吸收水分，无非三个途径：根压、毛细现象、升腾作用。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-6702ce63f13d713580e9d41d58500375_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"474\" data-original-token=\"v2-a040266da7cf86554e5be229883cce4a\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic4.zhimg.com/v2-6702ce63f13d713580e9d41d58500375_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"fqbC8s99\"\u003e对于高大的乔木来说，根压不足以将水分运送到植物的顶端，因为细胞液的浓度是有上限的，根据测算，根压一般为0.1MPa，也就是一个大气压，最多可以将水分推到10米的高度，所以日常生活中，10米高的树比比皆是，百米大树则十分罕见。\u003c/p\u003e\u003cp data-pid=\"BFNDFufm\"\u003e而毛细现象更无能为力，虽然大树内部存在大量的“水管”，在毛细作用下，水分可以上升的高度，取决于水浸润管壁形成的黏附力，当其与重力平衡时，水分也就升到了最大高度。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-a73bf621f2ef0448d1e94aa39d70f0bd_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"401\" data-original-token=\"v2-5465ecd0e14522548afe12b290c64c39\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic4.zhimg.com/v2-a73bf621f2ef0448d1e94aa39d70f0bd_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"EJvynQLK\"\u003e按照毛细效用的公式进行计算，在植物中毛细作用只能将水分运送在6米的高度。虽然不同植物内部的“水管”大小不同，运送高度也不同，但还是很难运送水分超过10米。\u003c/p\u003e\u003cp data-pid=\"BdPvZEfm\"\u003e其实，帮助高大乔木实现强大垂直运输力的还是被人忽视的“蒸腾作用”，对于西藏柏木来说，庞大的枝条和叶面形成的负压和扩散非常大，足以牵动整个树木内部的导管运输系统。\u003c/p\u003e\u003cp data-pid=\"m26Twe_I\"\u003e另外就是，大树内部的导管璧亲水，因此存贮的水分连接在一起，形成一个整体，使得叶面的连续拉动力量，得以克服10个以上的大气压。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-48b663e00ce181c693296217a787d450_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"571\" data-original-token=\"v2-168b1c20fa95d0cd70f1ddb59c7286d7\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic3.zhimg.com/v2-48b663e00ce181c693296217a787d450_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"xBb7vD0l\"\u003e叶面升腾作用\u003c/p\u003e\u003cp data-pid=\"z7KnnttX\"\u003e这就是为什么，一旦大树被砍了一刀，受损的组织部分会流出水分，这时候大树会迅速分泌东西修复到导管，或者从旁路建立新的持续供养管道。\u003c/p\u003e\u003cp data-pid=\"3DynVK3l\"\u003e但是，即便如此蒸腾作用还是十分有限，百米的大树还有“绝招”，世界上80米以上的巨树，无一例外都生活在降雨量充沛、水汽条件较好，气候温和的区域。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-b76dc44b92acc2da5fe67ad108360400_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"478\" data-original-token=\"v2-e5e4581b36d3d463188a4be867ab25fa\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pica.zhimg.com/v2-b76dc44b92acc2da5fe67ad108360400_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"yOfTrddf\"\u003e比如这次发现的世界第二、亚洲第一的102.3米的西藏柏木，就是位于藏东南波密县，这里位于雅鲁藏布大峡谷水汽北上的通道，年均降水量为1500-2000毫米，\u003cb\u003e这让超过60米的大树可以枝叶直接通过雾气和雨水就十分便利。\u003c/b\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-27f3647efaf815ae1635b281a342ff19_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"456\" data-original-token=\"v2-8793e17dff43b6c4dab7f123924a7cf7\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic4.zhimg.com/v2-27f3647efaf815ae1635b281a342ff19_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"t61GluuY\"\u003e即便巨树的成长需要“天时、地利、人和”，可是由于自然条件的限制，巨型大树的成长还是十分不容易，既要躲避雷击，还要克服顶端枯萎，才能在极其苛刻的条件下，长成百米大树。\u003c/p\u003e\u003cp data-pid=\"puOb1Ayn\"\u003e\u003cb\u003e联合调查队员李成说“这次发现可以改变地理教科书”，\u003c/b\u003e因此，我们在表达惊叹之情的同时，还是要呼吁大家保护好来自不易的大树。因为有时候，一棵苍天大树本身就是一门科学学科。\u003c/p\u003e\u003cp data-pid=\"BAEpwN1S\"\u003e参考：\u003c/p\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzg2NTcxOTkwNA%3D%3D%26mid%3D2247495360%26idx%3D1%26sn%3D0f2c535f43331cb52aaf9d0d4433e404%26chksm%3Dce576dcff920e4d9fe44b20b3f2de6b97e8a8353ae3a4438bbfde792ba789b4e8f81fae57445%26token%3D1421452697%26lang%3Dzh_CN%23rd\" data-draft-node=\"block\" data-draft-type=\"link-card\" data-image=\"https://pic4.zhimg.com/v2-69e16a1be3dc4cde9521d464207ff513_qhd.jpg\" data-image-width=\"1000\" data-image-height=\"425\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e中国发现102.3米高树，什么力量把水“抽”上百米高的树梢？\u003c/a\u003e\u003cp\u003e\u003c/p\u003e",
        "is_labeled": false,
        "visited_count": 102833,
        "favorite_count": 392
      },
      "brief": "{\"source\": \"TS\", \"type\": \"article\", \"id\": 650219347}",
      "attached_info": "CtkECM3ZsNrByc6OngEQBxoJMjMyNjIzMDAxIImk7aYGKJ4JMEpACEooChNUU19TT1VSQ0VfRkVFRFJFX1Y3EgEwGAAgADoKeyJyYXciOiIifVoIMTMxMjcyNzViIDBhNzBlOWZjZWViMTk2M2M0NjZlNmE0OGE2YzU1ZjZjcgk2NTAyMTkzNDeKARVjXzE1NzIxNzc2NDI1MDU0MjA4MDCqAQlyZWNvbW1lbmTCASAzZjU3MTJkNDk2N2ViMjMzYTRlMGYxOTA4ZjE5YTE4MvIBCggMEgZOb3JtYWzyASgIChIkM2E1ODIzNTEtYmJhMS00NmIwLWJjMWQtMGNjMmZlYTQyN2Fm8gEFCAsSATKCAgCIAujmgZqnMZICIDNmNTcxMmQ0OTY3ZWIyMzNhNGUwZjE5MDhmMTlhMTgymgIAygIWU2hvckludGVyZXN0V2VpZ2h0UnVsZdoCE1RTX1NPVVJDRV9GRUVEUkVfVjfoAgL6AgtOT1JNQUxfRkxPV4oDIGRkNDg4YmViZjk4MzRmYzM4MTQwODQ1OGE1ZGYyNjcymgMNCgJ2MhAAGgVvdGhlcqgDsaMG2AMA6gMJZmVlZHJlX3Y3+gMSEgxVTktOT1dOX01PREUgAEAAgAQAiAQAkgQGTm9ybWFsmgQBMqAEAKgEALAEALoEBm1hbnVhbMIEAzE2MMgEANIED+aOqOiNkOW3suabtOaWsNgEAOAEAvAEAPkEAAAAIArvtD+BBQAAAAAAAAAAiQWQWgq998jrP5IFCeaxn+Wkj+WMupoFA2RmdKIFA2RmdJICJAoJMjMyNjIzMDAxEgk2NTAyMTkzNDcYByIKSU1BR0VfVEVYVA==",
      "action_card": false
    },
    {
      "id": "9_1694150718.512",
      "type": "feed",
      "offset": 9,
      "verb": "TOPIC_ACKNOWLEDGED_ANSWER",
      "created_time": 1694150718,
      "updated_time": 1694150718,
      "target": {
        "id": 3196589186,
        "type": "answer",
        "url": "https://api.zhihu.com/answers/3196589186",
        "author": {
          "id": "39f31c521877abd7bf3be984a4ae16c1",
          "url": "https://api.zhihu.com/people/39f31c521877abd7bf3be984a4ae16c1",
          "user_type": "people",
          "url_token": "chao-hu-shuang",
          "name": "音栖息无",
          "headline": "",
          "avatar_url": "https://picx.zhimg.com/50/v2-f2a595f278e47a57e3f3661015bb0fed_l.jpg?source=b6762063",
          "is_org": false,
          "gender": -1,
          "followers_count": 46,
          "is_following": false,
          "is_followed": false
        },
        "created_time": 1693812441,
        "updated_time": 1693812441,
        "voteup_count": 239,
        "thanks_count": 54,
        "comment_count": 164,
        "is_copyable": true,
        "question": {
          "id": 471983693,
          "type": "question",
          "url": "https://api.zhihu.com/questions/471983693",
          "author": {
            "id": "5e911f71f18464043e596176562384aa",
            "url": "https://api.zhihu.com/people/5e911f71f18464043e596176562384aa",
            "user_type": "people",
            "url_token": "wang-guo-dong-82",
            "name": "大脐二橙",
            "headline": "养双胞胎女儿的奶爸，略懂制造业和科技产品，写温暖人心的文字~",
            "avatar_url": "https://pic1.zhimg.com/50/8db0d43a48c9c31e0286d12b333de3e0_l.jpg?source=b6762063",
            "is_org": false,
            "gender": 1,
            "followers_count": 51618,
            "is_following": false,
            "is_followed": false
          },
          "title": "有哪个瞬间，你特别想退出家长群？",
          "created": 1626161668,
          "answer_count": 1351,
          "follower_count": 4903,
          "comment_count": 34,
          "bound_topic_ids": [
            988,
            2146,
            4719,
            16608
          ],
          "is_following": false,
          "excerpt": "",
          "relationship": {
            "is_author": false
          },
          "detail": "",
          "question_type": "normal"
        },
        "thumbnail": "https://picx.zhimg.com/50/v2-75a28a07902a02d1baff9463f0ad8673_720w.jpg?source=b6762063",
        "excerpt": "我受不了已经退出了。现在都是孩子爸在煎熬。",
        "excerpt_new": "我受不了已经退出了。现在都是孩子爸在煎熬。",
        "preview_type": "default",
        "preview_text": "",
        "reshipment_settings": "allowed",
        "content": "\u003cp data-pid=\"z4D85GCw\"\u003e我受不了已经退出了。现在都是孩子爸在煎熬。\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-4ae9b075a15f1eef3ab5f4ce30a7077c_b.jpg\" data-rawwidth=\"945\" data-rawheight=\"1276\" data-size=\"normal\" data-original-token=\"v2-e875bb07c1ac65111dc2b9f7afa93a5a\" data-default-watermark-src=\"https://picx.zhimg.com/v2-10f83e2cfde1d38182dbfd25166da963_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"945\" data-original=\"https://pic1.zhimg.com/v2-4ae9b075a15f1eef3ab5f4ce30a7077c_r.jpg\"/\u003e\u003c/figure\u003e\u003cp\u003e\u003c/p\u003e",
        "relationship": {
          "is_thanked": false,
          "is_nothelp": false,
          "voting": 0
        },
        "is_labeled": false,
        "visited_count": 500309,
        "thumbnails": [
          "https://picx.zhimg.com/50/v2-75a28a07902a02d1baff9463f0ad8673_720w.jpg?source=b6762063"
        ],
        "favorite_count": 14,
        "answer_type": "normal"
      },
      "brief": "{\"source\": \"TS\", \"type\": \"answer\", \"id\": 3196589186}",
      "attached_info": "CuIFCM3ZsNrByc6OngEQBBoJNjExMjc5OTk1INmN1qcGKO8BMKQBQAlKJwocVFNfU09VUkNFX0hPVF9DUk9TU19SRUFMVElNRRIBMBgAIAA6AEo0CilUU19TT1VSQ0VfSE9UX0NST1NTX1JFQUxfVElNRV9ORVdfQ09OVEVOVBIBMBgAIAA6AEooChNUU19TT1VSQ0VfRkVFRFJFX1Y3EgEwGAAgADoKeyJyYXciOiIifVoINjcxNjQ5MDliIDBhNzBlOWZjZWViMTk2M2M0NjZlNmE0OGE2YzU1ZjZjcgozMTk2NTg5MTg2igEJNDcxOTgzNjkzqgEJcmVjb21tZW5kwgEgMzlmMzFjNTIxODc3YWJkN2JmM2JlOTg0YTRhZTE2YzHyAQoIDBIGTm9ybWFs8gEoCAoSJDlmZDliN2JmLThkNTMtNDk3Yi04NzU4LTAzOGVkYWE0MWY4YfIBBQgLEgEyggIAiALo5oGapzGSAiAzOWYzMWM1MjE4NzdhYmQ3YmYzYmU5ODRhNGFlMTZjMZoCAMoCEkNsaXBQZWFrV2VpZ2h0UnVsZcoCFlNob3JJbnRlcmVzdFdlaWdodFJ1bGXaAhxUU19TT1VSQ0VfSE9UX0NST1NTX1JFQUxUSU1F6AIC+gILTk9STUFMX0ZMT1eKAyBkZDQ4OGJlYmY5ODM0ZmMzODE0MDg0NThhNWRmMjY3MpoDDQoCdjIQABoFb3RoZXKoA9XEHtgDAOoDH2hvdENyb3NzUmVhbFRpbWVDb250ZW50UmVjYWxsZXL6AxISDFVOS05PV05fTU9ERSAAQACABACIBACSBAZOb3JtYWyaBAEyoAQAqAQAsAQAugQGbWFudWFswgQDMTYwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA4AQC8AQA+QQAAABg8hixP4EFAAAAAAAAAACJBZBaCr33yOs/kgUJ5rGf5aSP5Yy6mgUDZGZ0ogUDZGZ0kgIlCgk2MTEyNzk5OTUSCjMxOTY1ODkxODYYBCIKSU1BR0VfVEVYVA==",
      "action_card": false
    },
    {
      "id": "10_1694150718.161",
      "type": "feed",
      "offset": 10,
      "verb": "TOPIC_ACKNOWLEDGED_ANSWER",
      "created_time": 1694150718,
      "updated_time": 1694150718,
      "target": {
        "id": 3202100222,
        "type": "answer",
        "url": "https://api.zhihu.com/answers/3202100222",
        "author": {
          "id": "899eddeb113499e8b1d90cdf8df9fc25",
          "url": "https://api.zhihu.com/people/899eddeb113499e8b1d90cdf8df9fc25",
          "user_type": "people",
          "url_token": "1234huxian",
          "name": "架构随笔录",
          "headline": "Spring Cloud Alibaba微服务架构实战派作者",
          "avatar_url": "https://pica.zhimg.com/50/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg?source=b6762063",
          "is_org": false,
          "gender": 1,
          "followers_count": 8,
          "is_following": false,
          "is_followed": false
        },
        "created_time": 1694141056,
        "updated_time": 1694141221,
        "voteup_count": 0,
        "thanks_count": 0,
        "comment_count": 0,
        "is_copyable": true,
        "question": {
          "id": 464509584,
          "type": "question",
          "url": "https://api.zhihu.com/questions/464509584",
          "author": {
            "id": "8d71b59a5729f5489b9db4bfad3fbdbf",
            "url": "https://api.zhihu.com/people/8d71b59a5729f5489b9db4bfad3fbdbf",
            "user_type": "people",
            "url_token": "cwb927",
            "name": "陈文豹",
            "headline": "",
            "avatar_url": "https://pic1.zhimg.com/50/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg?source=b6762063",
            "is_org": false,
            "gender": -1,
            "followers_count": 1,
            "is_following": false,
            "is_followed": false
          },
          "title": "一个项目能同时使用  spring cloud 和 spring cloud alibaba 吗?",
          "created": 1623410449,
          "answer_count": 14,
          "follower_count": 13,
          "comment_count": 0,
          "bound_topic_ids": [
            50828,
            167241,
            177153
          ],
          "is_following": false,
          "excerpt": "",
          "relationship": {
            "is_author": false
          },
          "detail": "",
          "question_type": "normal"
        },
        "excerpt": "Spring Cloud Alibaba微服务架构实战派上下册作者（胡弦）来给你回答一下。在开源领域，RPC框架非常多，可以说是一片红海，各种类型的框架，比如Spring Cloud、Dubbo和蚂蚁金服的Sofa RPC等等。 当然我这里要说的就是Spring Cloud Alibaba，为什么要推荐大家去使用呢？ 首先，Spring Cloud Alibaba并不是一款纯碎的RPC框架，它是一款微服务治理框架，也就是说无论是你想自研微服务框架还是直接使用开源的微服务框架，那么使用Spr…",
        "excerpt_new": "Spring Cloud Alibaba微服务架构实战派上下册作者（胡弦）来给你回答一下。在开源领域，RPC框架非常多，可以说是一片红海，各种类型的框架，比如Spring Cloud、Dubbo和蚂蚁金服的Sofa RPC等等。 当然我这里要说的就是Spring Cloud Alibaba，为什么要推荐大家去使用呢？ 首先，Spring Cloud Alibaba并不是一款纯碎的RPC框架，它是一款微服务治理框架，也就是说无论是你想自研微服务框架还是直接使用开源的微服务框架，那么使用Spr…",
        "preview_type": "default",
        "preview_text": "",
        "reshipment_settings": "allowed",
        "content": "\u003ch2\u003eSpring Cloud Alibaba微服务架构实战派上下册作者（胡弦）来给你回答一下。\u003c/h2\u003e\u003cp data-pid=\"r0797WIZ\"\u003e在开源领域，RPC框架非常多，可以说是一片红海，各种类型的框架，比如Spring Cloud、Dubbo和蚂蚁金服的Sofa RPC等等。\u003c/p\u003e\u003cp data-pid=\"XN5iK5vd\"\u003e当然我这里要说的就是Spring Cloud Alibaba，为什么要推荐大家去使用呢？\u003c/p\u003e\u003cp data-pid=\"eyPYHCDF\"\u003e首先，Spring Cloud Alibaba并不是一款纯碎的RPC框架，它是一款微服务治理框架，也就是说无论是你想自研微服务框架还是直接使用开源的微服务框架，那么使用Spring Cloud Alibaba都可以做到开箱即用，并且也可以做到向Spring Boot和Spring Cloud的向下兼容。其次，Spring Cloud Alibaba是Spring Cloud和Spring Boot的超集，也就是说只要能够运用它们的业务场景，Spring Cloud Alibaba都是能够支持的。\u003c/p\u003e\u003cp data-pid=\"7a5gLpg9\"\u003e然后，Spring Cloud Alibaba针对阿里巴巴生态体系下的分布式中间件框架的使用和落地都是非常友好的，也就是说你想去使用阿里巴巴中间件团队开源的中间件能力，那么未来Spring Cloud Alibaba都会去支持。最后，Spring Cloud Alibaba是一款开发微服务的神器，研发人员可以基于它去构建一套体系化的微服务架构，从而实现分布式架构。\u003c/p\u003e\u003cp data-pid=\"PYEed90g\"\u003e总之，假如你的企业需要做架构转型，无论你是去做上云升级，还是要做业务重构，从而微服务化，还是你要做云原生技术升级，那么Spring Cloud Alibaba都是你的最佳选择。Spring Cloud Alibaba目前最新的版本为2021.0.4.0，这个版本有一个比较大的改动，那就是支持高版本的Spring Cloud Stream，比如3.2.5，也就是说开发人员可以在这个版本使用Spring Cloud Stream提供的函数式编程，并使用函数式编程去完成消息的生产和消费，并且可以同时支持RocketMQ、RabbitMQ、Kafka和Redis，这样开发人员可以进一步的提效。Spring Cloud Alibaba目前支持Sentinel、RocketMQ、Dubbo、Seata、Spring Cloud Gateway、Zuul、Spring Cloud（也包括它的所有的能力，比如多种注册中心Consul、Eureka、ZooKeeper和Nacos）。我相信现在很多企业都有上要上云的需求，也就是将自己的业务服务托管到云上，比如阿里云。阿里云为了方便大家去上云，提供了一套完整的微服务架构技术解决方案，也就是说你需要按照它提供的技术规范去改造，从而就可以使用它提供的微服务治理能力，也就是我们常说的商业化能力。这些商业化的能力都是有对应的开源版本的，比如RocketMQ和Nacos，都是开源版本，但是假如你现在需要升级为商业化版本，你就可以直接使用Spring Cloud Alibaba，先使用开源的中间件，然后就可以无缝的升级为商业化版本。当然Spring Cloud Alibaba确实是一款微服务架构的神器，但是它还是有很多能力是具备的，需要开发人员去定制化开发。当然，沿用Spring Cloud Alibaba改造分布式中间件的架构模式就可以定制化很多分布式中间的能力，这个都可以借鉴的。曾经在我的团队当中就借用Spring Cloud Alibaba的架构思想将原有的RPC框架进行升级改造，从而实现一个服务可以完成双注册中心和RPC框架之间的上下兼容。这个中兼容确实很重要，假如你的业务服务已经在使用旧的RPC框架，并且已经使用很多年了，这个时候你去升级技术，你不可能在第一阶段就将所有的业务服务改造完成，再整体上线，这个不太现实。\u003c/p\u003e\u003cp data-pid=\"-uCTmVJ9\"\u003e这个时候，你就需要梳理一部分服务，优先完成改造，但是无论你怎么尝试去做到高内聚低耦合，你都会存在新老服务相互依赖的业务场景，这个时候你就需要去做折中的改造，需要将新的服务，在新旧注册中心同时注册服务，从而新旧服务都可以订阅该服务。但是这个改造又不能对业务的侵入性太高，所以这个时候就需要按照Spring Cloud Alibaba的架构模式，重新重构旧的RPC框架的使用方式，这样即使整个团队的Spring Cloud Alibaba框架要升级，也不影响改造的框架的同步升级。总之，大家可以在自己的项目中去多多落地Spring Cloud Alibaba，才能从实战项目中去多总结和复盘该微服务治理框架的优势和缺点。\u003c/p\u003e\u003cp data-pid=\"Qj7nrRiS\"\u003e  Spring Cloud Alibaba致力于提供微服务开发的一站式解决方案，它是Spring Cloud组件被植入Alibaba元素之后的产物。利用Spring Cloud Alibaba，可以快速搭建微服务架构并完成技术升级。中小企业如果需要快速落地业务中台和技术中台，并向数字化业务转型，那Spring Cloud Alibaba绝对是一个“神器”。\u003c/p\u003e\u003cp data-pid=\"fgankv2a\"\u003e   本系列将带着大家一起鸟瞰Spring Cloud Alibaba注册中心，从而熟悉它的注册中心架构及相关原理。\u003c/p\u003e\u003cp data-pid=\"7FSIEnFO\"\u003e   咱们可以试着回忆下，没有Spring Cloud Alibaba之前，我们是如何使用Spring Cloud的？\u003c/p\u003e\u003ch3\u003e\u003cb\u003e\u003ci\u003e回忆Spring Cloud的使用方式\u003c/i\u003e\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"QQeypgsX\"\u003eSpring Cloud支持多种注册中心，比如Eureka、ZooKeeper、Consul等。\u003c/p\u003e\u003cp data-pid=\"6LsA8-e9\"\u003e    如果软件开发人员需要采用Eureka作为注册中心，则需要搭建一个Eureka Server集群，用于管理注册中心服务的元数据，然后应用服务需要接入Eureka，就需要使用对应的注解将服务提供者以及服务订阅者注册到Eureka注册中心。同理ZooKeeper和Consul也是采用同样的方式，使用对应注册中心的注解完成服务的注册和订阅。\u003c/p\u003e\u003cp data-pid=\"CKIMHq1H\"\u003e    Spring Cloud为了方便软件开发人员快速的接入不同的注册中心，统一使用注解@EnableDiscoveryClient+对应注册中心的Starter组件。当然Eureka还是沿用老的使用方式@EnableEurekaClient+对应注册中心的Starter组件，主要是由于Spring Cloud已经停止了对Eureka的维护。\u003c/p\u003e\u003cp data-pid=\"ETcoVgv5\"\u003e    好吧问题来了，Spring Cloud已经将ZooKeeper和Consul的使用方式统一起来，软件开发人员非常愉快的将应用接入Spring Cloud，但是目前市面上又出了一个新的注册中心，比如Nacos，它的性能非常高，并且支持CP和AP模式，但是Spring Cloud不支持。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e\u003ci\u003e定义Nacos注册中心的Starter组件\u003c/i\u003e\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"IpwV51hj\"\u003e为了满足软件开发人员对Nacos注册中心的述求，Spring Cloud Alibaba定义一个Starter组件spring-cloud-starter-alibaba-nacos-discovery，好吧我们来看看它是如何兼容Spring Cloud和Nacos的。\u003c/p\u003e\u003cp data-pid=\"XXh-URwV\"\u003e   首选，我们可以从Spring Cloud Alibaba架构师的视角去分析，如何做到使用“@EnableDiscoveryClient+spring-cloud-starter-alibaba-nacos-discovery”将服务接入Nacos注册中心。\u003c/p\u003e\u003cp data-pid=\"BYfPMS6B\"\u003e    其次，我们还要从软件开发人员的视角去分析，如何改造Nacos，并且还能够快速的支持Nacos的版本迭代更新。\u003c/p\u003e\u003cp data-pid=\"TikU5CJs\"\u003e    我们先来看第一个问题，架构师通常是这么分析问题的：既然是要软件开发人员零成本的从Eureka和Consul注册中心迁移到Nacos注册中心，我们一定要去摸清楚Spring Cloud的架构思想。\u003c/p\u003e\u003cp data-pid=\"OkqdLupO\"\u003e    第一步，我们可以打开注解@EnableDiscoveryClient的源码，它使用注解@Import自动的注入了一个EnableDiscoveryClientImportSelector类，如下所示：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e@Import(EnableDiscoveryClientImportSelector.class)\npublic @interface EnableDiscoveryClient {}\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"NWjXAm1b\"\u003e第二步，读者可以打开EnableDiscoveryClientImportSelector类，我们只看关键代码，如下所示：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e//①默认autoRegister=true\nif (autoRegister) {\n    List\u0026lt;String\u0026gt; importsList = new ArrayList\u0026lt;\u0026gt;(Arrays.asList(imports));\n//②利用Spring Boot的自动装配的原理，注入一个AutoServiceRegistrationConfiguration类\nimportsList.add(\u0026#34;org.springframework.cloud.client.serviceregistry.AutoServiceRegistrationConfiguration\u0026#34;);\n    imports = importsList.toArray(new String[0]);\n}\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"lxGW1RBA\"\u003e第三步，我们可以打开AutoServiceRegistrationConfiguration类，看关键源码，如下所示：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"nd\"\u003e@Configuration\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eproxyBeanMethods\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//①向Spring IOC容器中注入一个AutoServiceRegistrationProperties类\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nd\"\u003e@EnableConfigurationProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAutoServiceRegistrationProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//②使用Spring Boot的条件注解，定义一个开关，开关打开就可以完成初始化\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nd\"\u003e@ConditionalOnProperty\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;spring.cloud.service-registry.auto-registration.enabled\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ematchIfMissing\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAutoServiceRegistrationConfiguration\u003c/span\u003e \u003cspan class=\"o\"\u003e{}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"1K3s49RM\"\u003e第四步，我们打开AutoServiceRegistrationProperties类，看关键源码，如下所示：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"c1\"\u003e//①读取属性前缀为spring.cloud.service-registry.auto-registration.*的属性值\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nd\"\u003e@ConfigurationProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;spring.cloud.service-registry.auto-registration\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAutoServiceRegistrationProperties\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//②开启Spring Cloud的自动注册\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e \u003cspan class=\"n\"\u003eenabled\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//③开启Spring Cloud的注册管理\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e \u003cspan class=\"n\"\u003eregisterManagement\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//④关闭Spring Cloud的快速失败机制\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e \u003cspan class=\"n\"\u003efailFast\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"mUfjR8Cm\"\u003e第五步，看到这里，我们可以就认为Spring Cloud充分的利用的Spring Boot的自动装配和条件注解的思想，来控制自身资源的加载。那么Spring Cloud Alibaba会不会也是同样的思想呢？\u003c/p\u003e\u003cp data-pid=\"xMBGTn99\"\u003e我们再看看Spring Cloud Alibaba是怎么和Spring Cloud衔接的？\u003c/p\u003e\u003cp data-pid=\"-OrS_dOQ\"\u003e 第一步，我们使用IDEA查找Spring Cloud的AutoServiceRegistrationProperties类依赖关系，发现Spring Cloud Alibaba在Starter组件spring-cloud-starter-alibaba-nacos-discovery中使用了这个类，关键代码如下：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e//①利用AutoServiceRegistrationProperties类控制NacosRegistration类的初始化\n@Bean\n@ConditionalOnBean(AutoServiceRegistrationProperties.class)\npublic NacosRegistration nacosRegistration() {\n    return new NacosRegistration(registrationCustomizers.getIfAvailable(),\n                nacosDiscoveryProperties, context);\n}\n//②利用AutoServiceRegistrationProperties类控制NacosAutoServiceRegistration类的初始化\n@Bean\n@ConditionalOnBean(AutoServiceRegistrationProperties.class)\npublic NacosAutoServiceRegistration nacosAutoServiceRegistration() {\n    return new NacosAutoServiceRegistration(registry,\n                autoServiceRegistrationProperties, registration);\n}\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"bU8o2qMe\"\u003e第二步，看到这里我们应该恍然大悟，原来只是利用一个注解@EnableDiscoveryClient，就可以将Spring Cloud Alibaba和Spring Cloud衔接起来。\u003c/p\u003e\u003cp data-pid=\"UqwCplzk\"\u003e第三步，于是我们开发人员就可以使用如下方式，快速的开启Spring Cloud Alibaba+Nacos的开发之旅，如下：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e@EnableDiscoveryClient\n@SpringBootApplication\npublic class ProviderApplication {}\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"exBVOklJ\"\u003e好吧，关于Spring Cloud Alibaba是如何衔接Nacos的架构及原理，我会下接下来的文章中剖析，敬请期待。\u003c/p\u003e\u003cp data-pid=\"-E9z9II7\"\u003e\u003cb\u003e大家如果想学习更多的关于Spring Cloud Alibaba的知识，可以关注我的技术类书籍Spring Cloud Alibaba微服务架构实战派上下册。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"3Yg1fWcb\"\u003e\u003cb\u003e配套200+视频讲解和实战案例，绝对的干货满满。\u003c/b\u003e\u003c/p\u003e",
        "relationship": {
          "is_thanked": false,
          "is_nothelp": false,
          "voting": 0
        },
        "is_labeled": false,
        "visited_count": 140,
        "favorite_count": 2,
        "answer_type": "normal"
      },
      "brief": "{\"source\": \"TS\", \"type\": \"answer\", \"id\": 3202100222}",
      "attached_info": "CosFCM3ZsNrByc6OngEQBBoJNjEyMjgxMDc4IICV6qcGKAAwAEAKSi0KIlRTX1NPVVJDRV9DT05URU5UX1dBUk1VUF9GSU5EX1VTRVISATAYACAAOgBaCDY1NTAzNzQ0YiAwYTcwZTlmY2VlYjE5NjNjNDY2ZTZhNDhhNmM1NWY2Y3IKMzIwMjEwMDIyMooBCTQ2NDUwOTU4NKoBCXJlY29tbWVuZMIBIDg5OWVkZGViMTEzNDk5ZThiMWQ5MGNkZjhkZjlmYzI18gEKCAwSBk5vcm1hbPIBKAgKEiRlYTQ3NGQ0Mi1lNzc3LTQ0OWQtYTM0NC01ZjQ3MTM5MzAyOTHyAQUICxIBMoICAIgC6OaBmqcxkgIgODk5ZWRkZWIxMTM0OTllOGIxZDkwY2RmOGRmOWZjMjWaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIYQ29udGVudFdhcm1VcEJyZWFrSW5SdWxl2gIiVFNfU09VUkNFX0NPTlRFTlRfV0FSTVVQX0ZJTkRfVVNFUugCA/oCC05PUk1BTF9GTE9XigMgZGQ0ODhiZWJmOTgzNGZjMzgxNDA4NDU4YTVkZjI2NzKaAw0KAnYyEAAaBW90aGVyqAOMAdgDAOoDHXdhcm11cENvbnRlbnRGaW5kVXNlclJlY2FsbGVy+gMSEgxVTktOT1dOX01PREUgAEAAgAQAiAQAkgQGTm9ybWFsmgQBM6AEAKgEALAEALoEAmFpwgQDNDAwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA4AQC8AQA+QQAAABA9GSrP4EFAAAAAAAAAACJBZBaCr33yOs/kgUJ5rGf5aSP5Yy6mgUDZGZ0ogUDZGZ0kgIlCgk2MTIyODEwNzgSCjMyMDIxMDAyMjIYBCIKSU1BR0VfVEVYVA==",
      "action_card": false
    },
    {
      "id": "11_1694150718.123",
      "type": "feed",
      "offset": 11,
      "verb": "TOPIC_ACKNOWLEDGED_ANSWER",
      "created_time": 1694150718,
      "updated_time": 1694150718,
      "target": {
        "id": 3195748033,
        "type": "answer",
        "url": "https://api.zhihu.com/answers/3195748033",
        "author": {
          "id": "837fac86596bb8dc32eccd720d48643d",
          "url": "https://api.zhihu.com/people/837fac86596bb8dc32eccd720d48643d",
          "user_type": "people",
          "url_token": "xue-bi-76-53",
          "name": "雪碧",
          "headline": "我有故事，你有酒吗？",
          "avatar_url": "https://pic1.zhimg.com/50/v2-65b3ff3fc550217840396d38c691d48a_l.jpg?source=b6762063",
          "is_org": false,
          "gender": 0,
          "followers_count": 2733,
          "is_following": false,
          "is_followed": false
        },
        "created_time": 1693756580,
        "updated_time": 1693756580,
        "voteup_count": 289,
        "thanks_count": 32,
        "comment_count": 162,
        "is_copyable": true,
        "question": {
          "id": 26192324,
          "type": "question",
          "url": "https://api.zhihu.com/questions/26192324",
          "author": {
            "id": "a21b2c31497b4b46db78db2d24a5641b",
            "url": "https://api.zhihu.com/people/a21b2c31497b4b46db78db2d24a5641b",
            "user_type": "people",
            "url_token": "wnsouba",
            "name": "王华",
            "headline": "微信公众号：万能君的软件库。全是数码干货分享。",
            "avatar_url": "https://pica.zhimg.com/50/508747d593275374c1f2b2b3b99a59ea_l.jpg?source=b6762063",
            "is_org": false,
            "gender": 1,
            "badge": [
              {
                "type": "identity_people",
                "description": "中国石油大学(华东) 控制科学与工程硕士"
              }
            ],
            "followers_count": 62145,
            "is_following": false,
            "is_followed": false
          },
          "title": "没文化可以有多可怕？",
          "created": 1414042018,
          "answer_count": 18890,
          "follower_count": 165091,
          "comment_count": 265,
          "bound_topic_ids": [
            988,
            1309,
            2737,
            5582,
            2109549
          ],
          "is_following": false,
          "excerpt": "",
          "relationship": {
            "is_author": false
          },
          "detail": "",
          "question_type": "normal"
        },
        "excerpt": "我老公的大舅母，有一天突然摔倒在洗手间，没了呼吸。 她儿媳给她按压胸口，然后，用嘴对她吸气。 120来时，人已经没了呼吸，医生说已经没有抢救得必要了。 还是到了医院，直接宣布死亡。 人工呼吸，是对着人吹气，而不是吸气。 没文化，太可怕了。",
        "excerpt_new": "我老公的大舅母，有一天突然摔倒在洗手间，没了呼吸。 她儿媳给她按压胸口，然后，用嘴对她吸气。 120来时，人已经没了呼吸，医生说已经没有抢救得必要了。 还是到了医院，直接宣布死亡。 人工呼吸，是对着人吹气，而不是吸气。 没文化，太可怕了。",
        "preview_type": "default",
        "preview_text": "",
        "reshipment_settings": "allowed",
        "content": "\u003cp data-pid=\"assfkhtj\"\u003e我老公的大舅母，有一天突然摔倒在洗手间，没了呼吸。\u003c/p\u003e\u003cp data-pid=\"j5azUm8O\"\u003e她儿媳给她按压胸口，然后，用嘴对她吸气。\u003c/p\u003e\u003cp data-pid=\"5FT9axRT\"\u003e120来时，人已经没了呼吸，医生说已经没有抢救得必要了。\u003c/p\u003e\u003cp data-pid=\"SkMJIzOJ\"\u003e还是到了医院，直接宣布死亡。\u003c/p\u003e\u003cp data-pid=\"fkIuNr_h\"\u003e人工呼吸，是对着人吹气，而不是吸气。\u003c/p\u003e\u003cp data-pid=\"egNyEvue\"\u003e没文化，太可怕了。\u003c/p\u003e",
        "relationship": {
          "is_thanked": false,
          "is_nothelp": false,
          "voting": 0
        },
        "is_labeled": false,
        "visited_count": 626890,
        "favorite_count": 31,
        "answer_type": "normal"
      },
      "brief": "{\"source\": \"TS\", \"type\": \"answer\", \"id\": 3195748033}",
      "attached_info": "Cv8ECM3ZsNrByc6OngEQBBoJNjExMTI3MjgxIKTZ0qcGKKECMKIBQAtKJwocVFNfU09VUkNFX0hPVF9DUk9TU19SRUFMVElNRRIBMBgAIAA6AFoHMjY1OTg0NGIgMGE3MGU5ZmNlZWIxOTYzYzQ2NmU2YTQ4YTZjNTVmNmNyCjMxOTU3NDgwMzOKAQgyNjE5MjMyNKoBCXJlY29tbWVuZMIBIDgzN2ZhYzg2NTk2YmI4ZGMzMmVjY2Q3MjBkNDg2NDNk8gEKCAwSBk5vcm1hbPIBKAgKEiRkMTQyODJkZS00MmUxLTRkOTAtYjZiYS1iODc0N2ZhYTFmMjDyAQUICxIBMoICAIgC6OaBmqcxkgIgODM3ZmFjODY1OTZiYjhkYzMyZWNjZDcyMGQ0ODY0M2SaAgDKAhJDbGlwUGVha1dlaWdodFJ1bGXKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxl2gIcVFNfU09VUkNFX0hPVF9DUk9TU19SRUFMVElNRegCAvoCC05PUk1BTF9GTE9XigMgZGQ0ODhiZWJmOTgzNGZjMzgxNDA4NDU4YTVkZjI2NzKaAw0KAnYyEAAaBW90aGVyqAPKoSbYAwDqAx9ob3RDcm9zc1JlYWxUaW1lQ29udGVudFJlY2FsbGVy+gMSEgxVTktOT1dOX01PREUgAEAAgAQAiAQAkgQGTm9ybWFsmgQBMqAEAKgEALAEALoEBm1hbnVhbMIEAjMwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA4AQC8AQA+QQAAACA8hu6P4EFAAAAAAAAAACJBZBaCr33yOs/kgUJ5rGf5aSP5Yy6mgUDZGZ0ogUDZGZ0kgIlCgk2MTExMjcyODESCjMxOTU3NDgwMzMYBCIKSU1BR0VfVEVYVA==",
      "action_card": false
    }
  ],
  "paging": {
    "is_end": false,
    "is_start": false,
    "next": "https://www.zhihu.com/api/v3/feed/topstory/recommend?action=down\u0026ad_interval=-10\u0026after_id=11\u0026desktop=true\u0026page_number=3\u0026session_token=0a70e9fceeb1963c466e6a48a6c55f6c",
    "previous": "https://www.zhihu.com/api/v3/feed/topstory/recommend?action=pull\u0026ad_interval=-10\u0026before_id=11\u0026desktop=true\u0026page_number=3\u0026session_token=0a70e9fceeb1963c466e6a48a6c55f6c",
    "totals": 0
  },
  "fresh_text": "推荐已更新"
}